services:
  app:
    image: node:25-bookworm-slim
    working_dir: /app
    ports:
      - "5174:5174"
      - "8788:8788"
    volumes:
      - .:/app
      # Avoid mounting Windows host node_modules into the Linux container.
      - ss_node_modules:/app/node_modules
    environment:
      FINBERT_URL: ${FINBERT_URL:-}
      FINBERT_API_KEY: ${FINBERT_API_KEY:-}
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN:-}
      CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID:-}
    command:
      - sh
      - -c
      - |
        if [ ! -x node_modules/.bin/vite ]; then npm ci; fi

        EXTRA=""
        if [ -n "$$FINBERT_URL" ]; then EXTRA="$$EXTRA --binding FINBERT_URL=$$FINBERT_URL"; fi
        if [ -n "$$FINBERT_API_KEY" ]; then EXTRA="$$EXTRA --binding FINBERT_API_KEY=$$FINBERT_API_KEY"; fi

        if [ -z "$$CLOUDFLARE_API_TOKEN" ]; then
          echo "CLOUDFLARE_API_TOKEN not set; running frontend-only at http://localhost:5174"
          exec npm run dev -- --host 0.0.0.0
        fi

        # Full-stack dev: Vite + Pages Functions.
        npm run dev -- --host 0.0.0.0 &
        exec npx wrangler pages dev --ip 0.0.0.0 --port 8788 --proxy 5174 --show-interactive-dev-session false $$EXTRA

  finbert:
    profiles: ["finbert"]
    build:
      context: ./containers/finbert-esg
    environment:
      FINBERT_API_KEY: ${FINBERT_API_KEY:-}
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8080/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 90s

volumes:
  ss_node_modules:
